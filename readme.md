# 研究的点
针对大型数据中心的FPGA进行模拟攻击与防护。
# 背景
## 漏洞影响范围非常广
亚马逊aws f1实例被广泛使用。并且csps阿里巴巴、华为和Nimbix提供的FPGA实例采用的是用于AWS F1相同的Xilinx-VU9P设备，因此该类FPGA板子广泛应用，本文提出的攻击可在其他FPGA云环境中部署。
而intelFPGA与XilinxFPGA相似，基本具有相同的漏洞
## 当前的云上FPGA架构所采取的保护措施
当前主要采用设置几个安全栅栏(fences)来保护程序安全执行，包括
+ 检查用于潜在恶意电路的FPGA的设计
  + FPGA在加速器注册期间执行
  + 所有设计必须通过DRC检查才能执行
  + 供应商提供设计检查点格式的网表
  + 检查步骤：
    + 完整性检查，使用SHA256哈希确认DCP文件未损坏
    + 对尚未布线的网络进行扫描，查找恶意设计
    + 设备DNA用于检查用户访问的FPGA的ID，通常用于访问控制或者加密协议。
  + FPGA供应商提供设计检查规则以检查设计是否违规。主要的检查包括：LUTLP-1和LUTLP-2用于检查LUT组合循环；RPCL-1检测设计中任何组合循环。
  + 还会检查定时、IO、和电源违规。但是仅仅提供提醒，不会阻止。（这给了功率锤击提供了安全漏洞）
+ 由csps生成配置位流
  + csps将通过检查的设计生成一个由配置位流和一些元数据组成的AFI文件。
  + 配置位流是由供应商提供的工具将netlist转化得来的。其目的是为了防止FPGA中产生短路现象，从而防止攻击者对FPGA的破坏。
  + 无法绕过
+ 阻止直接访问FPGA配置端口的底层API
  +  AWS阻止任何对AFI文件的直接访问。
  +  一切编程只能通过AWS提供的接口进行。
  +  调试可通过AWS提供的虚拟设施来进行。
  +  无法绕过
+ FPGA的运行时监控
  + 三种安全机制：电源监控、限制功耗、故障保护机制来保护设备避免受热。
  + 电源监控
    + 通过读取温度传感器和获取核心电压进行系统监控
    + 但是不足以检测快速电压瞬变
  + 限制功耗
    + 允许减慢用户设计以将功耗限制在某一阈值之下。
    + 超过阈值时，将关闭所有用户时钟，以停止切换活动和相应的动态电源。
  + 故障保护机制
    + 设置一个临界温度作为保护FPGA设备的阈值
    + 超过此阈值时，FPGA所有驱动器停用
    + 全局激活
## 上述保护措施的不足之处
+ 栅栏1不足以检测不同类别的恶意电路
+ 栅栏4可以被绕过
+ 通过绕过栅栏1，可以删除栅栏2和3
+ 通过绕过栅栏4，恶意设计造成的伤害可能传播到系统的其他部分。
## 功率锤击
+ 功率锤击电势大的用户可能会破坏电源，并留下安全的操作电源电压裕度。
+ 功率锤击会在FPGA本身以及相邻设备中产生电压降。如果收到攻击的FPGA板共享某些硬件设施（如电源或冷却设施）。这可能是一种风险。
## FPGA设计流程
1. 逻辑设计。用户指定FPGA所要实现的的硬件功能，这一步使用硬件描述语言如Verilog或者VHDL或高级编程语言。
2. 资源映射。将上一步形成的逻辑函数映射到FPGA基元，例如LUT和DSP块。从而形成网表图。之后将该图映射到物理FPGA，将过程的结果进行再次包装，形成网络列表，使用netlist来表示。
3. 配置数据（位流）生成。生成用于FPGA变成的配置二进制文件。网络列表和比特流之间存在一一对应的关系。
# 文章的工作
文章完成了四个部分的工作
+ 针对基于FPGA的云计算实例攻击，对不同恶意强力锤击设计进行了评估。
+ 在FPGA上实现了一个指纹识别实例，用于具体的攻击效果评估。
+ AWS F1 FPGA云实例上的拒绝服务（DoS）演示。
+ 提出了缓解策略，包括供应商工具流程的自定义设计规则检查（Design Rule Checks，DRC），以及FPGAdefender FPGA病毒扫描器的重新实施。
# 攻击模型
## 云端实例
本文假设CSP（这里是AWS）可以可靠的托管多个用户，并且提供上述保护措施。
攻击者：
+ 可以是云服务用户
+ 也可以是AWS市场中的IP核心提供商，或者类似云IP分发系统。
假设攻击者掌握以下能力
+ 使用假冒身份在AWS F1实例上部署强力锤击，从而使大量实例崩溃。
+ 攻击本身使用FPGA配置，通过动态FPGA功耗造成过度浪费，从而造成F1实例崩溃或损坏，即DoS攻击。
+ 无法通过防止配置篡改的FPGA安全远程重新配置协议来防止上述情况。
# 针对FPGA的攻击与对策
在基于客户端的FPGA使用和基于云的FPGA使用之间，参与方的数量以及受害者与攻击者之间的物理距离是不同的，这导致了不同的攻击场景。
## 基于客户端的攻击方式
基于客户端的FPGA只受客户端自己控制，其他任何一方不能破坏其中的用户数据，但是攻击者可以使用物理手段提取获得访问权限，从而提取存储在系统中的信息。
攻击手段从简单到复杂都有，例如简单的比特流操作，以造成恶意的电气水平威胁（MELT），还有复杂的操作，例如电磁分析。
大多数攻击的目标是IP获取。
应对：FPGA可以配置加密双流。
## 基于云端的FPGA攻击方式
云端计算涉及到CSP、FPGA供应商、客户端和其他云用户。攻击面相较于基于客户端的大得多。具体攻击方式可分为三种：数据泄露、故障注入和拒绝服务攻击。
### 数据泄露
FPGA上的环形振荡器可以以6GHz的频率运行，这允许高精度的测量电源电压的波动。据此，已经有诸多攻击出现，例如远程电源侧信道攻击、串扰攻击和热隐蔽通道等。造成信息的泄漏。
目前AWS实例已经禁止基本的环形振荡器使用，供应商的DRC将检测基本环形振荡器。
但是本文列举出了可以绕过DRC检查并且已经部署在AWS实例上的替代振荡器电路。
### 故障注入攻击
快速振荡产生的动态功耗可能会导致FPGA内部、FPGA板配电网络和FPGA板供电电源的电压下降。这可能会触发定时违规和连续错误，从而用于减缓电路的注入故障和DoS攻击。
### 对策
+ 通过引入额外的定时延迟和随机化时钟来使系统对抗故障注入攻击时具有鲁棒性。
+ 通过监视系统来检测恶意行为。
+ 在执行恶意设计之前检测恶意设计。
+ 扫描设计是防止拒绝服务攻击的最重要的保护措施。
  + 辅助措施有功率和温度检测等。
# 针对云端FPGA AWS F1设施的拒绝服务攻击
针对云端的FPGA实例攻击范围广、影响深远。
## 攻击范围广
本文提出的功率锤击攻击针对所有的Xilinx FPGA均有效，这使得所有使用该FPGA的云端设施均面临威胁。同时，其他类型的FPGA如intel和Lattice也曾遇到过一些与之相关的攻击。
## 影响深远
使用功率锤击，即在几纳秒的时间内将功率从1瓦提升到1000瓦以上，从而破坏AWS F1实例。同时，功率锤击可以使FPGA超出其安全运行电源的范围。而在云端运行的FPGA通常共享一些基础设施，例如共享电源轨，这样的破坏会影响其他部件的正常运行。
# 对AWS EC2 F1实例使用功率锤击
AWS EC2 F1实例使用的FPGA开发板： **Xilinx UltraScale + VU9P FPGA**

FPGA的功耗可分为静态功耗和动态功耗。正常情况下，动态功耗在20%和70%之间波动。Xilinx使用估计器来评估动态功耗，以此来限制功耗。但是，恶意电路的功率增长速度可以远远超过估计器限制的速度，通常情况下要比估计器快两个数量级。因此攻击者可以据此绕过限制。

具体来说，功率锤击是使用两种恶意设计来进行攻击的：组合循环的设计和产生故障的设计。

## 组合循环设计
todo
## 产生故障的设计
使用一个触发器，输出被路由到XOR，但是具有不同的延时，故以触发器本身双倍的频率产生假信号。这个放大后的时钟被反馈到触发器，引起自行震荡。本文用这个概念来放大信号的故障，然后用它来驱动大量的布线。这增加了2700瓦的额外功率。从而达成功率锤击的目的。

# FPGA监控电源监控测试
当超过某些功率级别时，F1实例会出发不同的异常。本文通过测试功率级别来证明通过功率锤击使得AWS实例的SSH冻结。

当功率达到85w时，F1实例会发出电源警告，当达到105W时，shell会停止所有的用户时钟。此时用户无法再进行任何操作。但是本文使用了带透明锁的环境振荡器绕过了这个时钟门控机制，实现了一个时钟源。最终在功率达到134w时，ssh失去连接，AWS F1实例宕机。原因可能是过热关机。

# 建立靶场
在AWS EC2 F1中实现了一个指纹识别功能作为攻击靶场。

## 实现原因
+ 为了调查实例在崩溃后的行为，需要识别AWS中单个FPGA，以确定它们是否可用以及测量DoS攻击是否安装。
+ 但是AWS不提供用于用于识别的标识符；且AWS阻止用户访问FPGA上的唯一识别号。

## 实现细节
实现了一个用于FPGA指纹识别的PUF，这是一种基于振荡器的PUF指纹识别，使用透明锁存器失效哪了60个ROs，用相同用的无力路由路径约束所有的ROs，并且报告每个循环路径延迟为456ps

由于FPGA中有三个超逻辑区（SLR，集成在中间片上的独立芯片），因此在这三个SLR中各单独实现一个PUF有助于增加指纹识别的置信度。

同时，本文测试了PUF与工作温度（功率）的关系。发现随着温度的增加，PUF相应的时间也线性增加。

# 针对靶场的DoS攻击
## 目的
通过对靶场进行功率锤击攻击来判断该攻击方法的威力。

## 实施
使用396W的中等功率对实例进行破坏，然后通过计算再次启动所花时间来评估攻击效果。

步骤：
1. 创建实例
2. 进行一次指纹识别
3. 使用功率锤击使实例崩溃
4. 尝试在正常情况下再次接收同一个实例，测量所花费的时间

## 结果
在实例崩溃后，平均需要大约一个小时才能启动一个新的实例，最长时间达到22小时。

当攻击使得用户的实例崩溃后，用户需要花费很长的时间才能重新使用服务，假设用户是按时间计费，宕机重启产生的金钱损失将会很严重。同时，功率锤击潜力较大，客户可能会失去信心，设备可能会损失，这意味着更大的财务风险。

# 缓解策略
任何振荡器都可以用于功率锤击，其功率都可以轻易超过1kw，因此，缓解思路就是阻止任何振荡器的部署。
## 方法一：硬件层面
方法：提高更强的供电和冷却能力的FPGA板，电源配置要高一些。

评价：这种方法成本最高，但是这是对用户透明地缓解几乎任何问题。但是只能缓解中等水平的功率锤击，对于超过千瓦的功率锤击无济于事。

## 方法二：设计准则方面
方法：要求实例设计人员严格遵循编码准则。对供应链进行认证；对设计指南进行检查。

评价：会提高设计门槛，同时限制过多可能会导致客户满意度变差。

## 方法三：运行时监控方面
方法：对电源和温度进行监控

评价：只能对中等功率以下的攻击进行检测。对于瞬时大功率攻击，监测的速度往往很慢，FPGA容易在一瞬间崩溃损坏。

## 方法四：设计检查
方法：Xilinx供应商提供的DRC主要用于识别设计错误，而不是发现恶意电路。

评价：这种检查几乎是免费的，可以防止最严重的功率威胁。但是需要持续的维护。而且由于检查所有代码，这将涉及到知识产权保护的问题。

## 本文选择的方法
本文倾向于使用设计检查与硬件健壮性和运行时的安全检查相结合的的方法，因为可以最大限度的减少恶意设计的潜在威胁。

其中，为了保证知识产权不受侵害，可以对网表和比特流进行检查。同时，需要持续维护设计检查工具，来确保：
+ 检测出恶意设计
+ 良性设计不会被误伤

### 对网表以及比特流进行扫描
本文基于开源的FPGA病毒扫描框架FPGADefender实现了以下两个目标：
+ 一个可以在大型数据中心FPGA设计中运行的扫描框架。
+ 通过输入路径在DCP网表中直接扫描恶意电路。

所要执行的检查：
+ 组合反馈循环扫描器（Combinatorial Feedback Loop Scanner）。涵盖所有可能的组合反馈回路路径，包括携带链（carry- chains）、透明锁（transparent latches）、DSP块以及级联多路复用器的路径。
+ 扇出检测（Fanout Detection）。用于检测具有大扇出的驱动程序。为了防止恶意设计使用高扇出网络来控制攻击和使用路由资源
进行功率锤击。
+ 禁止端口检测（Disallowed Port Detection）。该策略允许检测FPGA上特定端口的使用情况。可用于禁止访问特定的FPGA原语或者FPGA整个区域，而不限制通过这些区域的路由。
+ 禁止路径检测（Disallowed Path Detection）。用于检测特定电线的使用情况，以防止设计在FPGA中使用不安全的电线。进而可以防止恶意设计利用如串扰效应从线路中提取数据。
+ 短路检测（Short Circuit Detection）。用于保证开关盒（switchbox）的编码是有效的，不会引起短路。是云服务商面向用户的，只用于位流扫描，而不适用于分析网表（即设计检查点）。
+ 故障检测（Glitch Detection）。用于计算最坏情况的动态功耗。

上述不同的检测会产生表明恶意的分数，云服务商可以根据分数来决定设计是否被接受。

## 将FPGADefender用于数据中心中的FPGA上
原有的基于python实现的扫描器部需要耗费较长时间才能部署到数据中心。为了提高部署速度，本文使用c++重写了扫描器。

+ 使用STL数据结构
+ 使用高效的算法进行扫描
  + 例如使用查找循环的Tarjans算法
+ 简化了LUT网列表计算，并消除了外部依赖关系。
  + 例如，使用自己的函数来替代外部依赖库的功能。

效果：将扫描速度从一天减少到几分钟

# 问题
1. 大方向上，这篇文章是提出了一个功率锤击攻击方案，并且用此方案锤击了AWS实例，并且讲解了实际方法，对吗？
2. 功率锤击的组合循环设计需要解释
3. 功率锤击具体是如何作用的？没看懂
4. RO、PUF在FPGA中是什么